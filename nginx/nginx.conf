# nginx/nginx.conf (Generated by generate_configs.py)
# DO NOT EDIT THIS FILE DIRECTLY - Modify .env and re-run generate_configs.py

# Define the group of upstream TEI servers that Nginx will balance load across
upstream tei_servers {
    # Load balancing strategy:
    # round-robin; # Default strategy, usually sufficient for stateless requests.
    # least_conn;  # Consider if request processing times vary significantly. Sends request to server with fewest active connections.
    # ip_hash;     # Ensures requests from the same client IP go to the same server (less useful here).

    server tei-0:80;
    server tei-1:80;

    # Optional: Keepalive connections to upstream servers can reduce latency for frequent requests.
    # keepalive 32;
}

server {
    # Nginx listens on port 80 *inside* its container. It's not exposed externally.
    listen 80;
    server_name localhost; # Internal server name

    # Default location block to proxy all requests coming from the cache-proxy service
    location / {
        # Pass requests to the upstream group defined above
        proxy_pass http://tei_servers;

        # Set standard proxy headers to pass client information (though less critical here as client is cache-proxy)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Optional: Adjust proxy timeouts if needed
        # proxy_connect_timeout 60s;
        # proxy_send_timeout 60s;
        # proxy_read_timeout 120s; # Increase if embedding large batches takes time
    }

    # Optional: Nginx status endpoint (accessible only within the docker network)
    location /nginx_status {
        stub_status;      # Nginx module provides basic status info
        allow 127.0.0.1;  # Allow access only from localhost within the container/network
        allow 172.16.0.0/12; # Allow access from default Docker bridge networks (adjust if needed)
        allow 192.168.0.0/16; # Allow access from common private networks (adjust if needed)
        deny all;         # Deny all other access
    }
}
